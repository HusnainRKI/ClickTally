/**
 * ClickTally Tracker
 */
!function(){var c=window.clickTallyConfig||{},a=c.apiUrl||'/wp-json/clicktally/v1/',n=c.nonce||'';if(c.respectDNT!==false&&navigator.doNotTrack==='1')return;var r=[],q=[],s=null,p=location.href,d=detectDevice(),t={},k=new Set();loadRules();document.addEventListener('click',handle,true);document.addEventListener('submit',handle,true);window.addEventListener('beforeunload',flush);setInterval(flush,5000);function loadRules(){var x=new XMLHttpRequest();x.open('GET',a+'rules');x.onload=function(){if(x.status===200)try{r=JSON.parse(x.responseText).rules||[]}catch(e){}};x.send()}function handle(e){r.forEach(function(rule){if(rule.event_type===e.type&&matches(e.target,rule))track(rule,e.target)})}function matches(el,rule){try{switch(rule.selector_type){case'id':return el.id===rule.selector_value;case'class':return el.classList.contains(rule.selector_value);case'css':return el.matches(rule.selector_value);case'data':return el.hasAttribute('data-'+rule.selector_value)}}catch(e){}return false}function track(rule,el){var key=rule.selector_key+'|'+rule.event_name;if(rule.once_per_view&&k.has(key))return;if(rule.throttle_ms>0){if(t[key])return;t[key]=setTimeout(function(){delete t[key]},rule.throttle_ms)}if(rule.once_per_view)k.add(key);q.push({ts:Date.now(),page_url:p,event_name:rule.event_name,selector_key:rule.selector_key,event_type:rule.event_type,device:d,is_logged_in:c.isLoggedIn,role:c.userRole});if(q.length>=5)flush()}function flush(){if(!q.length)return;var data=JSON.stringify(q.splice(0));if(navigator.sendBeacon){navigator.sendBeacon(a+'ingest',new Blob([data],{type:'application/json'}));return}var x=new XMLHttpRequest();x.open('POST',a+'ingest');x.setRequestHeader('Content-Type','application/json');x.setRequestHeader('X-WP-Nonce',n);x.send(data)}function detectDevice(){return/Mobile|Android|iPhone/.test(navigator.userAgent)?'mobile':screen.width<=1024?'tablet':'desktop'}}();